using Moq;
using NUnit.Framework;
using SatelittiBpms.Models.Infos;
using SatelittiBpms.Services.Interfaces;
using SatelittiBpms.VersionNormalization.Normalizations;
using System;
using System.Collections.Generic;

namespace SatelittiBpms.VersionNormalization.Tests.Normalizations
{
    public class WebSocketWorkFlowContentNormalizationTest
    {
        Mock<IProcessVersionService> _mockProcessVersionService;
        Mock<IServiceProvider> _mockServiceProvider;

        [SetUp]
        public void Setup()
        {
            _mockProcessVersionService = new Mock<IProcessVersionService>();
            _mockServiceProvider = new Mock<IServiceProvider>();
        }

        [Test]
        public void ensureThatRemoveFlowIdAndTaskIdFromStartEventActivityInputs()
        {
            var toBeChanged = "{\"Id\":\"2\",\"Version\":1,\"DataType\":\"SatelittiBpms.Workflow.Models.FlowDataInfo, SatelittiBpms.Workflow\",\"Steps\":[{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":\"Activity_0i7jxzu\",\"CancelCondition\":null,\"Id\":\"StartEvent_1\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.StartEventActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TaskId\":\"data.TaskId\",\"FlowId\":\"data.FlowId\",\"TenantId\":\"\\\"55\\\"\",\"ProcessVersionId\":\"\\\"2\\\"\",\"RequesterId\":\"data.RequesterId\",\"ActivityId\":\"\\\"6\\\"\"},\"Outputs\":{\"TaskId\":\"step.TaskId\",\"FlowId\":\"step.FlowId\"}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":\"Activity_1itcs2p\",\"CancelCondition\":null,\"Id\":\"Activity_0i7jxzu\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.UserTaskActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"RequesterId\":\"data.RequesterId\",\"ActivityId\":\"\\\"4\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"ActivityUserExecutorType\":\"\\\"REQUESTER\\\"\",\"ConnectionId\":\"data.ConnectionId\"},\"Outputs\":{\"TaskId\":\"step.TaskId\",\"Option\":\"step.Option\"}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":\"Event_0jijcgd\",\"CancelCondition\":null,\"Id\":\"Activity_1itcs2p\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.UserTaskActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"RequesterId\":\"data.RequesterId\",\"ActivityId\":\"\\\"5\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"ActivityUserExecutorType\":\"\\\"ROLE\\\"\",\"ConnectionId\":\"data.ConnectionId\"},\"Outputs\":{\"TaskId\":\"step.TaskId\",\"Option\":\"step.Option\"}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":null,\"CancelCondition\":null,\"Id\":\"Event_0jijcgd\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.EndEventActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"ActivityId\":\"\\\"7\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"ConnectionId\":\"data.ConnectionId\"},\"Outputs\":{}}]}";
            var expected = "{\"Id\":\"2\",\"Version\":1,\"DataType\":\"SatelittiBpms.Workflow.Models.FlowDataInfo, SatelittiBpms.Workflow\",\"Steps\":[{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":\"Activity_0i7jxzu\",\"CancelCondition\":null,\"Id\":\"StartEvent_1\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.StartEventActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"ProcessVersionId\":\"\\\"2\\\"\",\"RequesterId\":\"data.RequesterId\",\"ActivityId\":\"\\\"6\\\"\"},\"Outputs\":{\"TaskId\":\"step.TaskId\",\"FlowId\":\"step.FlowId\"}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":\"Activity_1itcs2p\",\"CancelCondition\":null,\"Id\":\"Activity_0i7jxzu\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.UserTaskActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"RequesterId\":\"data.RequesterId\",\"ActivityId\":\"\\\"4\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"ActivityUserExecutorType\":\"\\\"REQUESTER\\\"\",\"ConnectionId\":\"data.ConnectionId\"},\"Outputs\":{\"TaskId\":\"step.TaskId\",\"Option\":\"step.Option\"}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":\"Event_0jijcgd\",\"CancelCondition\":null,\"Id\":\"Activity_1itcs2p\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.UserTaskActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"RequesterId\":\"data.RequesterId\",\"ActivityId\":\"\\\"5\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"ActivityUserExecutorType\":\"\\\"ROLE\\\"\",\"ConnectionId\":\"data.ConnectionId\"},\"Outputs\":{\"TaskId\":\"step.TaskId\",\"Option\":\"step.Option\"}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":null,\"CancelCondition\":null,\"Id\":\"Event_0jijcgd\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.EndEventActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"ActivityId\":\"\\\"7\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"ConnectionId\":\"data.ConnectionId\"},\"Outputs\":{}}]}";

            var processVersionList = new List<ProcessVersionInfo>();
            processVersionList.Add(new ProcessVersionInfo() { Id = 1, WorkflowContent = toBeChanged });

            _mockProcessVersionService.Setup(x => x.ListAsync(It.IsAny<Dictionary<string, string>>())).ReturnsAsync(processVersionList);
            _mockServiceProvider.Setup(x => x.GetService(typeof(IProcessVersionService))).Returns(_mockProcessVersionService.Object);

            _20211206_WebSocketWorkFlowContentNormalization roleService = new _20211206_WebSocketWorkFlowContentNormalization(_mockServiceProvider.Object);
            var result = roleService.Execute();

            _mockProcessVersionService.Verify(x => x.UpdateWorkFlowContent(1, expected), Times.Once());
        }

        [Test]
        public void ensureThatRemoveProcessVersionIdAndAddConnectionIdInUserTaskActivityInputs()
        {
            var toBeChanged = "{\"Id\":\"2\",\"Version\":1,\"DataType\":\"SatelittiBpms.Workflow.Models.FlowDataInfo, SatelittiBpms.Workflow\",\"Steps\":[{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":\"Activity_0i7jxzu\",\"CancelCondition\":null,\"Id\":\"StartEvent_1\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.StartEventActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"ProcessVersionId\":\"\\\"2\\\"\",\"RequesterId\":\"data.RequesterId\",\"ActivityId\":\"\\\"6\\\"\"},\"Outputs\":{\"TaskId\":\"step.TaskId\",\"FlowId\":\"step.FlowId\"}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":\"Activity_1itcs2p\",\"CancelCondition\":null,\"Id\":\"Activity_0i7jxzu\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.UserTaskActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"RequesterId\":\"data.RequesterId\",\"ActivityId\":\"\\\"4\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"ActivityUserExecutorType\":\"\\\"REQUESTER\\\"\",\"ProcessVersionId\":\"\\\"2\\\"\"},\"Outputs\":{\"TaskId\":\"step.TaskId\",\"Option\":\"step.Option\"}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":\"Event_0jijcgd\",\"CancelCondition\":null,\"Id\":\"Activity_1itcs2p\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.UserTaskActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"RequesterId\":\"data.RequesterId\",\"ActivityId\":\"\\\"5\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"ActivityUserExecutorType\":\"\\\"ROLE\\\"\",\"ConnectionId\":\"data.ConnectionId\"},\"Outputs\":{\"TaskId\":\"step.TaskId\",\"Option\":\"step.Option\"}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":null,\"CancelCondition\":null,\"Id\":\"Event_0jijcgd\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.EndEventActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"ActivityId\":\"\\\"7\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"ConnectionId\":\"data.ConnectionId\"},\"Outputs\":{}}]}"; ;
            var expected = "{\"Id\":\"2\",\"Version\":1,\"DataType\":\"SatelittiBpms.Workflow.Models.FlowDataInfo, SatelittiBpms.Workflow\",\"Steps\":[{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":\"Activity_0i7jxzu\",\"CancelCondition\":null,\"Id\":\"StartEvent_1\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.StartEventActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"ProcessVersionId\":\"\\\"2\\\"\",\"RequesterId\":\"data.RequesterId\",\"ActivityId\":\"\\\"6\\\"\"},\"Outputs\":{\"TaskId\":\"step.TaskId\",\"FlowId\":\"step.FlowId\"}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":\"Activity_1itcs2p\",\"CancelCondition\":null,\"Id\":\"Activity_0i7jxzu\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.UserTaskActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"RequesterId\":\"data.RequesterId\",\"ActivityId\":\"\\\"4\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"ActivityUserExecutorType\":\"\\\"REQUESTER\\\"\",\"ConnectionId\":\"data.ConnectionId\"},\"Outputs\":{\"TaskId\":\"step.TaskId\",\"Option\":\"step.Option\"}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":\"Event_0jijcgd\",\"CancelCondition\":null,\"Id\":\"Activity_1itcs2p\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.UserTaskActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"RequesterId\":\"data.RequesterId\",\"ActivityId\":\"\\\"5\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"ActivityUserExecutorType\":\"\\\"ROLE\\\"\",\"ConnectionId\":\"data.ConnectionId\"},\"Outputs\":{\"TaskId\":\"step.TaskId\",\"Option\":\"step.Option\"}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":null,\"CancelCondition\":null,\"Id\":\"Event_0jijcgd\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.EndEventActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"ActivityId\":\"\\\"7\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"ConnectionId\":\"data.ConnectionId\"},\"Outputs\":{}}]}";

            var processVersionList = new List<ProcessVersionInfo>();
            processVersionList.Add(new ProcessVersionInfo() { Id = 1, WorkflowContent = toBeChanged });

            _mockProcessVersionService.Setup(x => x.ListAsync(It.IsAny<Dictionary<string, string>>())).ReturnsAsync(processVersionList);
            _mockServiceProvider.Setup(x => x.GetService(typeof(IProcessVersionService))).Returns(_mockProcessVersionService.Object);

            _20211206_WebSocketWorkFlowContentNormalization roleService = new _20211206_WebSocketWorkFlowContentNormalization(_mockServiceProvider.Object);
            var result = roleService.Execute();

            _mockProcessVersionService.Verify(x => x.UpdateWorkFlowContent(1, expected), Times.Once());
        }

        [Test]
        public void ensureThatRemoveProcessVersionIdAndAddConnectionIdInSendTaskActivityInputs()
        {
            var toBeChanged = "{\"Id\":\"3\",\"Version\":1,\"DataType\":\"SatelittiBpms.Workflow.Models.FlowDataInfo, SatelittiBpms.Workflow\",\"Steps\":[{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":\"Activity_1suwwiq\",\"CancelCondition\":null,\"Id\":\"StartEvent_1\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.StartEventActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"ActivityId\":\"\\\"12\\\"\",\"ProcessVersionId\":\"\\\"3\\\"\",\"RequesterId\":\"data.RequesterId\"},\"Outputs\":{\"TaskId\":\"step.TaskId\",\"FlowId\":\"step.FlowId\"}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":\"Gateway_0bdc5n6\",\"CancelCondition\":null,\"Id\":\"Activity_1suwwiq\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.UserTaskActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"ActivityId\":\"\\\"10\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"ConnectionId\":\"data.ConnectionId\",\"RequesterId\":\"data.RequesterId\",\"ActivityUserExecutorType\":\"\\\"REQUESTER\\\"\"},\"Outputs\":{\"TaskId\":\"step.TaskId\",\"Option\":\"step.Option\"}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElementExclusive, SatelittiBpms.Workflow\",\"SelectNextStep\":{\"Activity_1lre7fi\":\"data.Option == \\\"4\\\"\",\"Activity_1vi1ouw\":\"data.Option == \\\"5\\\"\"},\"Id\":\"Gateway_0bdc5n6\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.ExclusiveGatewayActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"ActivityId\":\"\\\"13\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"Option\":\"data.Option\"},\"Outputs\":{\"TaskId\":\"step.TaskId\"}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":\"Event_0p67kez\",\"CancelCondition\":null,\"Id\":\"Activity_1lre7fi\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.SendTaskActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"ActivityId\":\"\\\"14\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"ProcessVersionId\":\"\\\"3\\\"\",\"RequesterId\":\"data.RequesterId\"},\"Outputs\":{\"TaskId\":\"step.TaskId\"}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":null,\"CancelCondition\":null,\"Id\":\"Event_0p67kez\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.EndEventActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"ActivityId\":\"\\\"15\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"ConnectionId\":\"data.ConnectionId\"},\"Outputs\":{}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":\"Event_0p67kez\",\"CancelCondition\":null,\"Id\":\"Activity_1vi1ouw\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.UserTaskActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"ActivityId\":\"\\\"11\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"ConnectionId\":\"data.ConnectionId\",\"RequesterId\":\"data.RequesterId\",\"ActivityUserExecutorType\":\"\\\"REQUESTER\\\"\"},\"Outputs\":{\"TaskId\":\"step.TaskId\",\"Option\":\"step.Option\"}}]}";
            var expected = "{\"Id\":\"3\",\"Version\":1,\"DataType\":\"SatelittiBpms.Workflow.Models.FlowDataInfo, SatelittiBpms.Workflow\",\"Steps\":[{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":\"Activity_1suwwiq\",\"CancelCondition\":null,\"Id\":\"StartEvent_1\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.StartEventActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"ActivityId\":\"\\\"12\\\"\",\"ProcessVersionId\":\"\\\"3\\\"\",\"RequesterId\":\"data.RequesterId\"},\"Outputs\":{\"TaskId\":\"step.TaskId\",\"FlowId\":\"step.FlowId\"}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":\"Gateway_0bdc5n6\",\"CancelCondition\":null,\"Id\":\"Activity_1suwwiq\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.UserTaskActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"ActivityId\":\"\\\"10\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"ConnectionId\":\"data.ConnectionId\",\"RequesterId\":\"data.RequesterId\",\"ActivityUserExecutorType\":\"\\\"REQUESTER\\\"\"},\"Outputs\":{\"TaskId\":\"step.TaskId\",\"Option\":\"step.Option\"}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElementExclusive, SatelittiBpms.Workflow\",\"SelectNextStep\":{\"Activity_1lre7fi\":\"data.Option == \\\"4\\\"\",\"Activity_1vi1ouw\":\"data.Option == \\\"5\\\"\"},\"Id\":\"Gateway_0bdc5n6\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.ExclusiveGatewayActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"ActivityId\":\"\\\"13\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"Option\":\"data.Option\"},\"Outputs\":{\"TaskId\":\"step.TaskId\"}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":\"Event_0p67kez\",\"CancelCondition\":null,\"Id\":\"Activity_1lre7fi\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.SendTaskActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"ActivityId\":\"\\\"14\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"RequesterId\":\"data.RequesterId\",\"ConnectionId\":\"data.ConnectionId\"},\"Outputs\":{\"TaskId\":\"step.TaskId\"}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":null,\"CancelCondition\":null,\"Id\":\"Event_0p67kez\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.EndEventActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"ActivityId\":\"\\\"15\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"ConnectionId\":\"data.ConnectionId\"},\"Outputs\":{}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":\"Event_0p67kez\",\"CancelCondition\":null,\"Id\":\"Activity_1vi1ouw\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.UserTaskActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"ActivityId\":\"\\\"11\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"ConnectionId\":\"data.ConnectionId\",\"RequesterId\":\"data.RequesterId\",\"ActivityUserExecutorType\":\"\\\"REQUESTER\\\"\"},\"Outputs\":{\"TaskId\":\"step.TaskId\",\"Option\":\"step.Option\"}}]}";

            var processVersionList = new List<ProcessVersionInfo>();
            processVersionList.Add(new ProcessVersionInfo() { Id = 1, WorkflowContent = toBeChanged });

            _mockProcessVersionService.Setup(x => x.ListAsync(It.IsAny<Dictionary<string, string>>())).ReturnsAsync(processVersionList);
            _mockServiceProvider.Setup(x => x.GetService(typeof(IProcessVersionService))).Returns(_mockProcessVersionService.Object);

            _20211206_WebSocketWorkFlowContentNormalization roleService = new _20211206_WebSocketWorkFlowContentNormalization(_mockServiceProvider.Object);
            var result = roleService.Execute();

            _mockProcessVersionService.Verify(x => x.UpdateWorkFlowContent(1, expected), Times.Once());
        }

        [Test]
        public void ensureThatRemoveProcessVersionIdAndRequesterIdInExclusiveGatwayActivityInputs()
        {
            var toBeChanged = "{\"Id\":\"3\",\"Version\":1,\"DataType\":\"SatelittiBpms.Workflow.Models.FlowDataInfo, SatelittiBpms.Workflow\",\"Steps\":[{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":\"Activity_1suwwiq\",\"CancelCondition\":null,\"Id\":\"StartEvent_1\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.StartEventActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"ActivityId\":\"\\\"12\\\"\",\"ProcessVersionId\":\"\\\"3\\\"\",\"RequesterId\":\"data.RequesterId\"},\"Outputs\":{\"TaskId\":\"step.TaskId\",\"FlowId\":\"step.FlowId\"}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":\"Gateway_0bdc5n6\",\"CancelCondition\":null,\"Id\":\"Activity_1suwwiq\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.UserTaskActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"ActivityId\":\"\\\"10\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"ConnectionId\":\"data.ConnectionId\",\"RequesterId\":\"data.RequesterId\",\"ActivityUserExecutorType\":\"\\\"REQUESTER\\\"\"},\"Outputs\":{\"TaskId\":\"step.TaskId\",\"Option\":\"step.Option\"}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElementExclusive, SatelittiBpms.Workflow\",\"SelectNextStep\":{\"Activity_1lre7fi\":\"data.Option == \\\"4\\\"\",\"Activity_1vi1ouw\":\"data.Option == \\\"5\\\"\"},\"Id\":\"Gateway_0bdc5n6\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.ExclusiveGatewayActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"ProcessVersionId\":\"\\\"2\\\"\",\"RequesterId\":\"data.RequesterId\",\"TenantId\":\"\\\"55\\\"\",\"ActivityId\":\"\\\"13\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"Option\":\"data.Option\"},\"Outputs\":{\"TaskId\":\"step.TaskId\"}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":\"Event_0p67kez\",\"CancelCondition\":null,\"Id\":\"Activity_1lre7fi\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.SendTaskActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"ActivityId\":\"\\\"14\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"ConnectionId\":\"data.ConnectionId\",\"RequesterId\":\"data.RequesterId\"},\"Outputs\":{\"TaskId\":\"step.TaskId\"}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":null,\"CancelCondition\":null,\"Id\":\"Event_0p67kez\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.EndEventActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"ActivityId\":\"\\\"15\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"ConnectionId\":\"data.ConnectionId\"},\"Outputs\":{}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":\"Event_0p67kez\",\"CancelCondition\":null,\"Id\":\"Activity_1vi1ouw\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.UserTaskActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"ActivityId\":\"\\\"11\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"ConnectionId\":\"data.ConnectionId\",\"RequesterId\":\"data.RequesterId\",\"ActivityUserExecutorType\":\"\\\"REQUESTER\\\"\"},\"Outputs\":{\"TaskId\":\"step.TaskId\",\"Option\":\"step.Option\"}}]}";
            var expected = "{\"Id\":\"3\",\"Version\":1,\"DataType\":\"SatelittiBpms.Workflow.Models.FlowDataInfo, SatelittiBpms.Workflow\",\"Steps\":[{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":\"Activity_1suwwiq\",\"CancelCondition\":null,\"Id\":\"StartEvent_1\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.StartEventActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"ActivityId\":\"\\\"12\\\"\",\"ProcessVersionId\":\"\\\"3\\\"\",\"RequesterId\":\"data.RequesterId\"},\"Outputs\":{\"TaskId\":\"step.TaskId\",\"FlowId\":\"step.FlowId\"}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":\"Gateway_0bdc5n6\",\"CancelCondition\":null,\"Id\":\"Activity_1suwwiq\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.UserTaskActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"ActivityId\":\"\\\"10\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"ConnectionId\":\"data.ConnectionId\",\"RequesterId\":\"data.RequesterId\",\"ActivityUserExecutorType\":\"\\\"REQUESTER\\\"\"},\"Outputs\":{\"TaskId\":\"step.TaskId\",\"Option\":\"step.Option\"}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElementExclusive, SatelittiBpms.Workflow\",\"SelectNextStep\":{\"Activity_1lre7fi\":\"data.Option == \\\"4\\\"\",\"Activity_1vi1ouw\":\"data.Option == \\\"5\\\"\"},\"Id\":\"Gateway_0bdc5n6\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.ExclusiveGatewayActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"ActivityId\":\"\\\"13\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"Option\":\"data.Option\"},\"Outputs\":{\"TaskId\":\"step.TaskId\"}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":\"Event_0p67kez\",\"CancelCondition\":null,\"Id\":\"Activity_1lre7fi\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.SendTaskActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"ActivityId\":\"\\\"14\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"ConnectionId\":\"data.ConnectionId\",\"RequesterId\":\"data.RequesterId\"},\"Outputs\":{\"TaskId\":\"step.TaskId\"}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":null,\"CancelCondition\":null,\"Id\":\"Event_0p67kez\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.EndEventActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"ActivityId\":\"\\\"15\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"ConnectionId\":\"data.ConnectionId\"},\"Outputs\":{}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":\"Event_0p67kez\",\"CancelCondition\":null,\"Id\":\"Activity_1vi1ouw\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.UserTaskActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"ActivityId\":\"\\\"11\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"ConnectionId\":\"data.ConnectionId\",\"RequesterId\":\"data.RequesterId\",\"ActivityUserExecutorType\":\"\\\"REQUESTER\\\"\"},\"Outputs\":{\"TaskId\":\"step.TaskId\",\"Option\":\"step.Option\"}}]}";

            var processVersionList = new List<ProcessVersionInfo>();
            processVersionList.Add(new ProcessVersionInfo() { Id = 1, WorkflowContent = toBeChanged });

            _mockProcessVersionService.Setup(x => x.ListAsync(It.IsAny<Dictionary<string, string>>())).ReturnsAsync(processVersionList);
            _mockServiceProvider.Setup(x => x.GetService(typeof(IProcessVersionService))).Returns(_mockProcessVersionService.Object);

            _20211206_WebSocketWorkFlowContentNormalization roleService = new _20211206_WebSocketWorkFlowContentNormalization(_mockServiceProvider.Object);
            var result = roleService.Execute();

            _mockProcessVersionService.Verify(x => x.UpdateWorkFlowContent(1, expected), Times.Once());
        }

        [Test]
        public void ensureThatAddConnectionIdAndRemoveProcessVersionIdAndRequesterIdInEndEventActivityInputs()
        {
            var toBeChanged = "{\"Id\":\"2\",\"Version\":1,\"DataType\":\"SatelittiBpms.Workflow.Models.FlowDataInfo, SatelittiBpms.Workflow\",\"Steps\":[{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":\"Activity_0i7jxzu\",\"CancelCondition\":null,\"Id\":\"StartEvent_1\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.StartEventActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"ProcessVersionId\":\"\\\"2\\\"\",\"RequesterId\":\"data.RequesterId\",\"ActivityId\":\"\\\"6\\\"\"},\"Outputs\":{\"TaskId\":\"step.TaskId\",\"FlowId\":\"step.FlowId\"}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":\"Activity_1itcs2p\",\"CancelCondition\":null,\"Id\":\"Activity_0i7jxzu\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.UserTaskActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"RequesterId\":\"data.RequesterId\",\"ActivityId\":\"\\\"4\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"ActivityUserExecutorType\":\"\\\"REQUESTER\\\"\",\"ConnectionId\":\"data.ConnectionId\"},\"Outputs\":{\"TaskId\":\"step.TaskId\",\"Option\":\"step.Option\"}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":\"Event_0jijcgd\",\"CancelCondition\":null,\"Id\":\"Activity_1itcs2p\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.UserTaskActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"RequesterId\":\"data.RequesterId\",\"ActivityId\":\"\\\"5\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"ActivityUserExecutorType\":\"\\\"ROLE\\\"\",\"ConnectionId\":\"data.ConnectionId\"},\"Outputs\":{\"TaskId\":\"step.TaskId\",\"Option\":\"step.Option\"}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":null,\"CancelCondition\":null,\"Id\":\"Event_0jijcgd\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.EndEventActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"ActivityId\":\"\\\"7\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"ProcessVersionId\":\"\\\"2\\\"\",\"RequesterId\":\"data.RequesterId\"},\"Outputs\":{}}]}";
            var expected = "{\"Id\":\"2\",\"Version\":1,\"DataType\":\"SatelittiBpms.Workflow.Models.FlowDataInfo, SatelittiBpms.Workflow\",\"Steps\":[{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":\"Activity_0i7jxzu\",\"CancelCondition\":null,\"Id\":\"StartEvent_1\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.StartEventActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"ProcessVersionId\":\"\\\"2\\\"\",\"RequesterId\":\"data.RequesterId\",\"ActivityId\":\"\\\"6\\\"\"},\"Outputs\":{\"TaskId\":\"step.TaskId\",\"FlowId\":\"step.FlowId\"}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":\"Activity_1itcs2p\",\"CancelCondition\":null,\"Id\":\"Activity_0i7jxzu\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.UserTaskActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"RequesterId\":\"data.RequesterId\",\"ActivityId\":\"\\\"4\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"ActivityUserExecutorType\":\"\\\"REQUESTER\\\"\",\"ConnectionId\":\"data.ConnectionId\"},\"Outputs\":{\"TaskId\":\"step.TaskId\",\"Option\":\"step.Option\"}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":\"Event_0jijcgd\",\"CancelCondition\":null,\"Id\":\"Activity_1itcs2p\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.UserTaskActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"RequesterId\":\"data.RequesterId\",\"ActivityId\":\"\\\"5\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"ActivityUserExecutorType\":\"\\\"ROLE\\\"\",\"ConnectionId\":\"data.ConnectionId\"},\"Outputs\":{\"TaskId\":\"step.TaskId\",\"Option\":\"step.Option\"}},{\"$type\":\"SatelittiBpms.Workflow.WorkflowCoreElements.StepElement, SatelittiBpms.Workflow\",\"NextStepId\":null,\"CancelCondition\":null,\"Id\":\"Event_0jijcgd\",\"StepType\":\"SatelittiBpms.Workflow.ActivityTypes.EndEventActivity, SatelittiBpms.Workflow\",\"Inputs\":{\"TenantId\":\"\\\"55\\\"\",\"ActivityId\":\"\\\"7\\\"\",\"FlowId\":\"data.FlowId\",\"TaskId\":\"data.TaskId\",\"ConnectionId\":\"data.ConnectionId\"},\"Outputs\":{}}]}";

            var processVersionList = new List<ProcessVersionInfo>();
            processVersionList.Add(new ProcessVersionInfo() { Id = 1, WorkflowContent = toBeChanged });

            _mockProcessVersionService.Setup(x => x.ListAsync(It.IsAny<Dictionary<string, string>>())).ReturnsAsync(processVersionList);
            _mockServiceProvider.Setup(x => x.GetService(typeof(IProcessVersionService))).Returns(_mockProcessVersionService.Object);

            _20211206_WebSocketWorkFlowContentNormalization roleService = new _20211206_WebSocketWorkFlowContentNormalization(_mockServiceProvider.Object);
            var result = roleService.Execute();

            _mockProcessVersionService.Verify(x => x.UpdateWorkFlowContent(1, expected), Times.Once());
        }

    }
}
